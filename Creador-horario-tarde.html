<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de tarde</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        .color-option.selected {
            border-color: #000;
        }
        .color-option.used {
            opacity: 0.5;
            position: relative;
        }
        .color-option.used::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: black;
            font-weight: bold;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .time-column {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #scheduleTable td {
            cursor: pointer;
            font-weight: bold;
        }
        .export-buttons {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .delete-mode {
            background-color: #f44336 !important;
        }
        .json-buttons {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .time-editor {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7e9;
            border-radius: 5px;
        }
        .time-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <h1>Organizador de tarde</h1>
    
    <div class="controls">
        <input type="text" id="subjectInput" placeholder="Nombre de la actividad">
        <button onclick="addSubject()">Añadir Actividad</button>
        
        <div>
            <p>Selecciona un color:</p>
            <div class="color-options" id="colorOptions">
                <!-- Colores se generarán con JavaScript -->
            </div>
        </div>
        
        <div class="time-editor">
            <p><strong>Editor de Franjas Horarias:</strong></p>
            <div id="timeInputs" class="time-inputs">
                <!-- Las entradas de tiempo se generarán con JavaScript -->
            </div>
            <button onclick="updateTimeSlots()" style="margin-top: 10px;">Actualizar Horarios</button>
        </div>
    </div>
    
    <table id="scheduleTable">
        <thead>
            <tr>
                <th>Horario</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
            </tr>
        </thead>
        <tbody id="scheduleBody">
            <!-- Las filas se generarán dinámicamente con JavaScript -->
        </tbody>
    </table>
    
    <div class="buttons">
        <button onclick="generatePDF('portrait')">Descargar PDF (Vertical)</button>
        <button onclick="generatePDF('landscape')">Descargar PDF (Horizontal)</button>
        <button onclick="exportToExcel()">Descargar Excel</button>
        <button onclick="toggleDeleteMode()" id="deleteModeBtn">Borrar Celda</button>
        <button onclick="clearSchedule()" style="background-color: #f44336;">Limpiar Horario</button>
    </div>

    <div class="json-buttons">
        <button onclick="saveToJSON()">Guardar Horario (JSON)</button>
        <button onclick="loadFromJSON()">Cargar Horario (JSON)</button>
        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
    </div>

    <script>
        // Variables globales
        let currentSubject = null;
        let currentColor = null;
        let deleteMode = false;
        const colors = [
            '#c23517', '#c29d17', '#38d943', '#7fbad4', '#d4208c',
            '#edf261', '#393f96', '#963993', '#5484d1', '#FFB6C1',
            '#f51417', '#40c2e6', '#f0a1e9', '#27a147', '#b7c9bc'
        ];
        
        // Franjas horarias iniciales
        let timeSlots = [
            "16:00 - 17:00",
            "17:00 - 18:00",
            "18:00 - 19:00",
            "19:00 - 20:00",
            "20:00 - 20:30",
            "20:30 - 21:00"
        ];
        
        // Inicializar opciones de color
        function initColorOptions() {
            const colorOptionsDiv = document.getElementById('colorOptions');
            colorOptionsDiv.innerHTML = '';
            
            colors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.backgroundColor = color;
                colorDiv.dataset.color = color;
                
                // Ya no verificamos si el color está en uso para permitir reutilización
                if (color === currentColor) {
                    colorDiv.classList.add('selected');
                }
                
                colorDiv.onclick = function() {
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    currentColor = color;
                };
                
                colorOptionsDiv.appendChild(colorDiv);
            });
        }
        
        // Inicializar editor de franjas horarias
        function initTimeEditor() {
            const timeInputsDiv = document.getElementById('timeInputs');
            timeInputsDiv.innerHTML = '';
            
            timeSlots.forEach((slot, index) => {
                const [startTime, endTime] = slot.split(' - ');
                
                const timeGroup = document.createElement('div');
                timeGroup.className = 'time-input-group';
                
                const slotLabel = document.createElement('span');
                slotLabel.textContent = `Franja ${index + 1}:`;
                
                const startInput = document.createElement('input');
                startInput.type = 'time';
                startInput.value = startTime;
                startInput.dataset.index = index;
                startInput.dataset.type = 'start';
                
                const separator = document.createElement('span');
                separator.textContent = ' - ';
                
                const endInput = document.createElement('input');
                endInput.type = 'time';
                endInput.value = endTime;
                endInput.dataset.index = index;
                endInput.dataset.type = 'end';
                
                timeGroup.appendChild(slotLabel);
                timeGroup.appendChild(startInput);
                timeGroup.appendChild(separator);
                timeGroup.appendChild(endInput);
                
                timeInputsDiv.appendChild(timeGroup);
            });
        }
        
        // Actualizar las franjas horarias
        function updateTimeSlots() {
            const timeInputs = document.querySelectorAll('#timeInputs input[type="time"]');
            const newTimeSlots = [];
            
            // Agrupar por índice
            const groupedInputs = {};
            timeInputs.forEach(input => {
                const index = input.dataset.index;
                if (!groupedInputs[index]) {
                    groupedInputs[index] = {};
                }
                groupedInputs[index][input.dataset.type] = input.value;
            });
            
            // Crear nuevos timeSlots
            Object.keys(groupedInputs).forEach(index => {
                const { start, end } = groupedInputs[index];
                if (start && end) {
                    newTimeSlots.push(`${start} - ${end}`);
                }
            });
            
            timeSlots = newTimeSlots;
            renderScheduleTable();
            alert('Franjas horarias actualizadas correctamente');
        }
        
        // Renderizar la tabla de horarios
        function renderScheduleTable() {
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            
            timeSlots.forEach(slot => {
                const row = document.createElement('tr');
                
                // Celda de tiempo
                const timeCell = document.createElement('td');
                timeCell.className = 'time-column';
                timeCell.textContent = slot;
                row.appendChild(timeCell);
                
                // Celdas para cada día
                for (let i = 0; i < 5; i++) {
                    const dayCell = document.createElement('td');
                    dayCell.addEventListener('click', assignSubject);
                    row.appendChild(dayCell);
                }
                
                scheduleBody.appendChild(row);
            });
        }
        
        // Añadir nueva actividad
        function addSubject() {
            const subjectName = document.getElementById('subjectInput').value.trim();
            if (!subjectName) {
                alert('Por favor, introduce un nombre para la actividad');
                return;
            }
            
            if (!currentColor) {
                alert('Por favor, selecciona un color para la actividad');
                return;
            }
            
            currentSubject = {
                name: subjectName,
                color: currentColor
            };
            
            document.getElementById('subjectInput').value = '';
            
            alert(`Actividad "${subjectName}" lista para asignar. Haz clic en las celdas del horario para colocarla.`);
        }
        
        // Asignar actividad a celda
        function assignSubject(event) {
            if (deleteMode) {
                // Si estamos en modo borrado, limpiar la celda
                clearCell(event.target);
                return;
            }
            
            if (!currentSubject) {
                alert('Primero añade una actividad y selecciona un color');
                return;
            }
            
            const cell = event.target;
            if (cell.classList.contains('time-column')) return;
            
            // Si la celda ya tiene una actividad, limpiarla primero
            if (cell.textContent || cell.style.backgroundColor) {
                clearCell(cell);
            }
            
            cell.textContent = currentSubject.name;
            cell.style.backgroundColor = currentSubject.color;
            
            // Determinar si el color es oscuro para usar texto blanco
            if (isDarkColor(currentSubject.color)) {
                cell.style.color = 'white';
            } else {
                cell.style.color = 'black';
            }
        }
        
        // Limpiar una celda individual
        function clearCell(cell) {
            cell.textContent = '';
            cell.style.backgroundColor = '';
            cell.style.color = 'black';
        }
        
        // Alternar modo borrado
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            const deleteBtn = document.getElementById('deleteModeBtn');
            
            if (deleteMode) {
                deleteBtn.classList.add('delete-mode');
                deleteBtn.textContent = 'Modo Borrado Activado';
                alert('Modo borrado activado. Haz clic en cualquier celda para borrar su contenido.');
            } else {
                deleteBtn.classList.remove('delete-mode');
                deleteBtn.textContent = 'Borrar Celda';
            }
        }
        
        // Verificar si un color es oscuro
        function isDarkColor(color) {
            // Convertir color hexadecimal a RGB
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            
            // Calcular brillo según percepción humana
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness < 128;
        }
        
        // Guardar horario a JSON
        function saveToJSON() {
            const scheduleData = {
                timeSlots: timeSlots,
                schedule: []
            };
            
            // Recopilar información de las celdas
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            rows.forEach((row, rowIndex) => {
                const timeSlot = row.querySelector('.time-column').textContent;
                const dayCells = row.querySelectorAll('td:not(.time-column)');
                
                const rowData = {
                    time: timeSlot,
                    days: []
                };
                
                dayCells.forEach((cell, dayIndex) => {
                    rowData.days.push({
                        subject: cell.textContent,
                        color: cell.style.backgroundColor || '',
                        textColor: cell.style.color || 'black'
                    });
                });
                
                scheduleData.schedule.push(rowData);
            });
            
            // Crear y descargar archivo JSON
            const dataStr = JSON.stringify(scheduleData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'organizador_tarde.json';
            link.click();
        }
        
        // Cargar horario desde JSON
        function loadFromJSON() {
            const fileInput = document.getElementById('jsonFileInput');
            fileInput.click();
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const scheduleData = JSON.parse(event.target.result);
                        loadScheduleData(scheduleData);
                        alert('Horario cargado correctamente');
                    } catch (error) {
                        alert('Error al cargar el archivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                // Limpiar el input para permitir cargar el mismo archivo otra vez
                fileInput.value = '';
            };
        }
        
        // Cargar datos del horario desde objeto JSON
        function loadScheduleData(scheduleData) {
            // Actualizar franjas horarias si están incluidas en el JSON
            if (scheduleData.timeSlots) {
                timeSlots = scheduleData.timeSlots;
                renderScheduleTable();
                initTimeEditor();
            }
            
            // Cargar los datos del horario
            const rows = document.querySelectorAll('#scheduleTable tbody tr');
            scheduleData.schedule.forEach((rowData, rowIndex) => {
                if (rowIndex >= rows.length) return;
                
                const dayCells = rows[rowIndex].querySelectorAll('td:not(.time-column)');
                rowData.days.forEach((dayData, dayIndex) => {
                    if (dayIndex >= dayCells.length) return;
                    
                    const cell = dayCells[dayIndex];
                    if (dayData.subject) {
                        cell.textContent = dayData.subject;
                        cell.style.backgroundColor = dayData.color;
                        cell.style.color = dayData.textColor;
                    }
                });
            });
        }
        
        // Generar PDF con tamaño de letra aumentado y celdas uniformes
        function generatePDF(orientation) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm'
            });
            
            const originalTable = document.getElementById('scheduleTable');
            
            // Crear un clon de la tabla para modificar sin afectar la visualización
            const clone = originalTable.cloneNode(true);
            
            // Aplicar estilos para uniformidad en el PDF
            clone.style.width = '100%';
            clone.style.fontSize = '22px'; // Tamaño de fuente más grande
            
            // Asegurar que todas las celdas tengan el mismo tamaño
            const allCells = clone.querySelectorAll('td, th');
            allCells.forEach(cell => {
                cell.style.width = '16%';
                cell.style.height = '80px';
                cell.style.boxSizing = 'border-box';
                cell.style.padding = '8px';
                cell.style.wordWrap = 'break-word';
            });
            
            // Especificar anchos de columna para uniformidad
            const headers = clone.querySelectorAll('th');
            if (headers.length > 0) {
                // Calcular porcentajes exactos para que sumen 100%
                const timeColumnWidth = 15; // 15% para la columna de horario
                const dayColumnWidth = (100 - timeColumnWidth) / (headers.length - 1); // El resto dividido entre los días
                
                headers[0].style.width = timeColumnWidth + '%'; // Columna de horario
                for (let i = 1; i < headers.length; i++) {
                    headers[i].style.width = dayColumnWidth + '%'; // Columnas de días (igual ancho)
                }
                
                // Aplicar el mismo ancho a las celdas del cuerpo de la tabla
                const bodyCells = clone.querySelectorAll('td');
                bodyCells.forEach((cell, index) => {
                    if (index % headers.length === 0) {
                        cell.style.width = timeColumnWidth + '%'; // Primera columna (horario)
                    } else {
                        cell.style.width = dayColumnWidth + '%'; // Columnas de días
                    }
                });
            }
            
            // Asegurar que todas las filas tengan la misma altura
            const rows = clone.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.height = '40px';
            });
            
            // Ocultar el clon visualmente pero mantenerlo en el DOM para html2canvas
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            document.body.appendChild(clone);
            
            const scale = orientation === 'portrait' ? 2.5 : 2;
            
            html2canvas(clone, { 
                scale: scale,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth() - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                doc.save('organizador_tarde.pdf');
                document.body.removeChild(clone);
            });
        }
        
        // Exportar a Excel
        function exportToExcel() {
            const table = document.getElementById('scheduleTable');
            const workbook = XLSX.utils.table_to_book(table, {sheet: "Horario"});
            
            // Ajustar el ancho de las columnas
            const ws = workbook.Sheets["Horario"];
            const colWidths = [
                {wch: 12}, // Horario
                {wch: 20}, // Lunes
                {wch: 20}, // Martes
                {wch: 20}, // Miércoles
                {wch: 20}, // Jueves
                {wch: 20}  // Viernes
            ];
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(workbook, 'organizador_tarde.xlsx');
        }
        
        // Limpiar horario
        function clearSchedule() {
            if (confirm('¿Estás seguro de que quieres limpiar todo el horario?')) {
                document.querySelectorAll('#scheduleTable td:not(.time-column)').forEach(cell => {
                    clearCell(cell);
                });
                
                // Resetear variables
                currentSubject = null;
                currentColor = null;
                deleteMode = false;
                document.getElementById('deleteModeBtn').classList.remove('delete-mode');
                document.getElementById('deleteModeBtn').textContent = 'Borrar Celda';
            }
        }
        
        // Inicializar la página
        window.onload = function() {
            initColorOptions();
            initTimeEditor();
            renderScheduleTable();
        };
    </script>
</body>
</html>